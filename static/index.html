<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>以图搜片</title>
  <style>
    :root {
      --bg: #0f0f12;
      --surface: #18181c;
      --border: #2a2a30;
      --text: #e4e4e7;
      --muted: #a1a1aa;
      --accent: #7c3aed;
      --accent-hover: #8b5cf6;
      --success: #22c55e;
      --error: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "SF Pro Text", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    .wrap {
      max-width: 960px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    h1 {
      font-size: 1.75rem;
      font-weight: 600;
      margin: 0 0 0.5rem;
      letter-spacing: -0.02em;
    }
    .sub {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 2rem;
    }
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 2.5rem;
      text-align: center;
      background: var(--surface);
      transition: border-color 0.2s, background 0.2s;
      cursor: pointer;
      margin-bottom: 1rem;
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--accent);
      background: rgba(124, 58, 237, 0.06);
    }
    .upload-zone input[type="file"] {
      position: absolute;
      width: 0;
      height: 0;
      opacity: 0;
      pointer-events: none;
    }
    .upload-zone .hint {
      color: var(--muted);
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }
    .preview-wrap {
      margin-top: 1rem;
      display: inline-block;
    }
    .preview-wrap img {
      max-width: 280px;
      max-height: 180px;
      object-fit: contain;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .actions {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .btn {
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary {
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:hover:not(:disabled) {
      background: var(--accent-hover);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-ghost {
      background: transparent;
      color: var(--muted);
    }
    .btn-ghost:hover { color: var(--text); }
    .top-k {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--muted);
      font-size: 0.875rem;
    }
    .top-k select {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      font-size: 0.875rem;
    }
    .status {
      margin-top: 1rem;
      font-size: 0.9rem;
      min-height: 1.5em;
    }
    .status.loading { color: var(--muted); }
    .status.error { color: var(--error); }
    .status.success { color: var(--success); }
    .results-section {
      margin-top: 2.5rem;
    }
    .results-section h2 {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 1rem;
      color: var(--muted);
    }
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }
    .result-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      transition: border-color 0.2s;
    }
    .result-card:hover { border-color: var(--accent); }
    .result-card .thumb {
      width: 100%;
      aspect-ratio: 16/10;
      object-fit: cover;
      display: block;
      background: var(--bg);
    }
    .result-card .body {
      padding: 0.75rem;
    }
    .result-card .score {
      font-size: 0.8rem;
      color: var(--accent);
      font-weight: 500;
      margin-bottom: 0.35rem;
    }
    .result-card .time {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.35rem;
    }
    .result-card .link {
      font-size: 0.75rem;
      color: var(--muted);
      word-break: break-all;
    }
    .result-card .link a {
      color: var(--accent);
      text-decoration: none;
    }
    .result-card .link a:hover { text-decoration: underline; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>以图搜片</h1>
    <p class="sub">上传一张图片，检索最相似的关键帧与来源视频</p>

    <div class="upload-zone" id="zone" role="button" tabindex="0">
      <input type="file" id="file" accept="image/jpeg,image/png,image/webp,image/gif" />
      <div id="zoneText">点击或拖拽图片到此处</div>
      <div class="hint">支持 JPEG、PNG、WebP、GIF，最大 16MB</div>
      <div class="preview-wrap hidden" id="previewWrap">
        <img id="preview" alt="预览" />
      </div>
    </div>

    <div class="actions">
      <button type="button" class="btn btn-primary" id="searchBtn" disabled>搜索</button>
      <button type="button" class="btn btn-ghost" id="clearBtn">清空</button>
      <div class="top-k">
        <label for="topK">返回条数</label>
        <select id="topK">
          <option value="6">6</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
          <option value="30">30</option>
        </select>
      </div>
    </div>
    <div class="status" id="status" aria-live="polite"></div>

    <section class="results-section hidden" id="resultsSection">
      <h2 id="resultsTitle">检索结果</h2>
      <div class="results-grid" id="resultsGrid"></div>
    </section>
  </div>

  <script>
    const zone = document.getElementById("zone");
    const fileInput = document.getElementById("file");
    const previewWrap = document.getElementById("previewWrap");
    const preview = document.getElementById("preview");
    const searchBtn = document.getElementById("searchBtn");
    const clearBtn = document.getElementById("clearBtn");
    const topK = document.getElementById("topK");
    const status = document.getElementById("status");
    const resultsSection = document.getElementById("resultsSection");
    const resultsTitle = document.getElementById("resultsTitle");
    const resultsGrid = document.getElementById("resultsGrid");

    function setStatus(msg, type) {
      status.textContent = msg;
      status.className = "status " + (type || "");
    }

    function setPreview(file) {
      if (!file) {
        previewWrap.classList.add("hidden");
        preview.removeAttribute("src");
        searchBtn.disabled = true;
        return;
      }
      const url = URL.createObjectURL(file);
      preview.onload = () => URL.revokeObjectURL(url);
      preview.src = url;
      previewWrap.classList.remove("hidden");
      searchBtn.disabled = false;
    }

    zone.addEventListener("click", () => fileInput.click());
    zone.addEventListener("dragover", (e) => {
      e.preventDefault();
      zone.classList.add("dragover");
    });
    zone.addEventListener("dragleave", () => zone.classList.remove("dragover"));
    zone.addEventListener("drop", (e) => {
      e.preventDefault();
      zone.classList.remove("dragover");
      const f = e.dataTransfer?.files?.[0];
      if (f && f.type.startsWith("image/")) {
        fileInput.files = e.dataTransfer.files;
        setPreview(f);
      }
    });
    fileInput.addEventListener("change", () => {
      const f = fileInput.files?.[0];
      setPreview(f || null);
    });

    clearBtn.addEventListener("click", () => {
      fileInput.value = "";
      setPreview(null);
      setStatus("");
      resultsSection.classList.add("hidden");
    });

    searchBtn.addEventListener("click", async () => {
      const f = fileInput.files?.[0];
      if (!f) return;
      setStatus("正在检索…", "loading");
      resultsSection.classList.add("hidden");
      const form = new FormData();
      form.append("image", f);
      const k = topK.value;
      try {
        const r = await fetch("/api/search?top_k=" + encodeURIComponent(k), {
          method: "POST",
          body: form,
        });
        const data = await r.json();
        if (!r.ok) {
          setStatus("错误：" + (data.error || r.statusText), "error");
          return;
        }
        const results = data.results || [];
        setStatus("找到 " + results.length + " 条结果", "success");
        resultsTitle.textContent = "检索结果（" + results.length + " 条）";
        resultsGrid.innerHTML = results.map((item, i) => {
          const time = item.timestamp_sec != null ? item.timestamp_sec.toFixed(1) + "s" : "—";
          const video = item.video_path || "";
          const link = video ? "<a href=\"" + escapeHtml(video) + "\" target=\"_blank\" rel=\"noopener\">来源</a>" : "—";
          const thumb = item.frame_url
            ? "<img class=\"thumb\" src=\"" + escapeHtml(item.frame_url) + "\" alt=\"\" loading=\"lazy\" />"
            : "<div class=\"thumb\" style=\"background:var(--border);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:0.8rem;\">无预览</div>";
          return (
            "<article class=\"result-card\">" +
            thumb +
            "<div class=\"body\">" +
            "<div class=\"score\">相似度 " + (item.score != null ? (item.score * 100).toFixed(1) + "%" : "—") + "</div>" +
            "<div class=\"time\">" + time + "</div>" +
            "<div class=\"link\">" + link + "</div>" +
            "</div></article>"
          );
        }).join("");
        resultsSection.classList.remove("hidden");
      } catch (err) {
        setStatus("请求失败：" + err.message, "error");
      }
    });

    function escapeHtml(s) {
      const div = document.createElement("div");
      div.textContent = s;
      return div.innerHTML;
    }
  </script>
</body>
</html>
